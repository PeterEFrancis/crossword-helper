<!doctype html>
<html lang="en" class="h-100">
  <head>
    <title>Crossword Helper</title>
    <!-- <link rel="icon" type="image/png" href="/static/logo.png"> -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="keywords" content="">

    <!-- Bootstrap -->
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- JQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>

    <script src="xw.js"></script>

    <style>
      canvas {
        border: 1px solid black;
        width: 100%;
      }
    </style>

  </head>

  <body class="d-flex flex-column h-100">

    <div class="container">
      <div clsas="row">
        <div class="my-3 col-md-12 text-center">
          <h1>Crossword Helper</h1>
        </div>
      </div>
      <div class="row mt-5">
        <div class="col-sm-3">     
          <div class="input-group mb-3" style="width: 100%;">
            <input id="N" type="number" step="1" min="2" value="10" class="form-control" placeholder="size">
            <button class="btn btn-danger" onclick="new_grid()">Reset</button>
          </div>
        </div>
        <div class="col-sm-3">
          <button type="button" class="btn btn-outline-secondary" onclick="download_image()" style="width: 100%">
            Download
          </button>
        </div>
        <div class="col-sm-3">
          <button type="button" class="btn btn-outline-secondary" onclick="toggle_letters()" style="width: 100%">
            Toggle Fill
          </button>
        </div>
        <div class="col-sm-3">
          <div class="input-group mb-3" style="width: 100%;">
            <input id="k" type="number" step="1" min="2" value="2" class="form-control" placeholder="size">
            <button class="btn btn-warning" onclick="handle_filler()">Find Fill</button>
          </div>
        </div>
        
      </div>
      <div class="row my-5">
        <div class="col-md-6">
          
          <canvas id="canvas" width="1000" height="1000">
            Browser doesn't support canvas element.
          </canvas>
          
          <div class="row">
            <div class="col-sm-6">
              <h4>Down</h4>
              <p id="down" style="font-family: monospace;"></p>
            </div>
            <div class="col-sm-6">
              <h4>Across</h4>
              <p id="across" style="font-family: monospace;"></p>
            </div>
          </div>
        </div>

        <div class="col-md-6">
          <h3 class="pt-2">
            Word Suggestions&nbsp;&nbsp;
            <div class="form-switch" style="display: inline-block;">
              <input class="form-check-input" type="checkbox" oninput="toggle_suggestions(this.checked)">
            </div>
          </h3>
          <strong>Possible Letters: </strong><span id="poss"></span>
          <!-- <br><br>
          <input id="filter" class="form-control" placeholder="filter"> -->
          <br>
          <p id="suggestions" style="column-count: 3; font-family: monospace;"></p>
        </div>
        
      </div>
    </div>
  </body>

  <script>
    
    let N;
    let pre_grid = localStorage.getItem("grid");
    if (pre_grid) {
      pre_grid = JSON.parse(pre_grid);
      N = pre_grid.length ** (1/2);
    } else {
      pre_grid = get_blank_array(15 ** 2);
      N = 15;
    }
    document.getElementById("N").value = N;


    var xw = new XW(pre_grid, true);


    var LW = 2;
    var selected_square_id = -1;
    var dir = 1;
    var typing = false;

    var show_letters = true;

    var show_suggestions = false;


    var canvas = document.getElementById('canvas');
    var ctx = canvas.getContext('2d');



    window.addEventListener("load", function (e) {
      update();
    });
    



    function toggle_suggestions(bool) {
      show_suggestions = bool;
      update();
    }

    function new_grid() {
      let N = Number(document.getElementById('N').value);
      xw = new XW(get_blank_array(N ** 2));
      selected_square_id = -1;
      update();
    }

    function toggle_letters() {
      show_letters = !show_letters;
      update();
    }

    function get_square_id() {
      let rect = canvas.getBoundingClientRect();
      let user_x = (event.clientX - rect.left) * (canvas.width / canvas.clientWidth);
      let user_y = (event.clientY - rect.top) * (canvas.height / canvas.clientHeight);
      let row = Math.floor(user_y / (canvas.width / N));
      let col = Math.floor(user_x / (canvas.width / N));
      return row * N + col;
    }


    document.addEventListener('click', function(e) {
      if (e.srcElement == canvas) {
        typing = true;
        click_canvas(e);
      } else {
        typing = false;
        selected_square_id = -1;
      }
      update();
    });

    function click_canvas(e) {
      new_selected_square_id = get_square_id(e);

      if (xw.grid[new_selected_square_id] == BLACK) {
        selected_square_id = -1;
      }
      if (new_selected_square_id == selected_square_id) {
        dir = 1 + xw.N - dir;
      }
      selected_square_id = new_selected_square_id;
    }

    window.addEventListener('keydown', function(e) {
      if (typing) {
        if (!(event.metaKey || event.ctrlKey) && (e.keyCode >= 65 && e.keyCode <= 90 && xw.grid[selected_square_id] != BLACK)) {
          xw.grid[selected_square_id] = e.key;
          move(dir);
        } else if (e.key == 'Backspace' && xw.grid[selected_square_id] != BLACK) {
          xw.grid[selected_square_id] = WHITE;
          move(-dir);
        } else if (e.key == 'ArrowLeft') {
          move(-1)
        } else if (e.key == 'ArrowRight' || e.key == ' ') {
          move(1)
        } else if (e.key == 'ArrowUp') {
          move(-N);
        } else if (e.key == 'ArrowDown') {
          move(N);
        } else if (e.key == '.') {
          toggle_black(selected_square_id);
        }
        update();
        e.preventDefault();
      }
    });


    function move(dr) {
      selected_square_id = (selected_square_id + dr) % (xw.N ** 2);
    }



    function get_possible_letters(pos) {
      let horiz_locs = xw.get_word_locs(pos, 1);
      let horiz_pos = horiz_locs.indexOf(pos);
      let horiz_word = xw.get_word(pos, 1);
      let horiz_matches = get_matches(horiz_word);
      let horiz_letters = horiz_matches.map(x => x[horiz_pos]);

      let vert_locs = xw.get_word_locs(pos, N);
      let vert_pos = vert_locs.indexOf(pos);
      let vert_word = xw.get_word(pos, xw.N);
      let vert_matches = get_matches(vert_word);
      let vert_letters = vert_matches.map(x => x[vert_pos]);

      return Array.from(new Set(horiz_letters).intersection(new Set(vert_letters))).sort().join(", ").toUpperCase();
    }



    function update() {

      localStorage.setItem("grid", JSON.stringify(xw.grid));

      if (selected_square_id >= xw.N ** 2) {
        selected_square_id = -1;
      }

      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // draw grid
      ctx.fillStyle = "black";
      for (let i = 0; i <= xw.N + 1; i++) {
        ctx.fillRect(0 - LW / 2, i * (canvas.height / xw.N) - LW / 2, canvas.width, LW);
        ctx.fillRect(i * (canvas.width / xw.N) - (LW / 2), 0, LW, canvas.width);
      }

      // numbers
      let nums = xw.get_numbers();


      // get Down and Across
      let down = [];
      let across = [];
      for (let i = 0; i < xw.N ** 2; i++) {
        let r = Math.floor(i / xw.N);
        let c = i % xw.N;
        if (nums[i] > 0) {
          if (r == 0 || xw.grid[N * (r - 1) + c] == BLACK) {
            let word = xw.get_word(i, xw.N);
            if (word.length > 1) {
              down[nums[i]] = word;
            }
          }
          if (c == 0 || xw.grid[N * r + c - 1] == BLACK) {
            let word = xw.get_word(i, 1);
            if (word.length > 1) {
              across[nums[i]] = word;
            }
          }
        }
      }

      document.getElementById('down').innerHTML = "";
      document.getElementById('across').innerHTML = "";
      for (let i in down) {
        document.getElementById('down').innerHTML += i + ". " + down[i].toUpperCase() + "<br>"
      }
      for (let i in across) {
        document.getElementById('across').innerHTML += i + ". " + across[i].toUpperCase() + "<br>"
      }

      let curr;
      if (selected_square_id > -1 && xw.grid[selected_square_id] != BLACK) {
        curr = xw.get_word_locs(selected_square_id, dir);
      } 

      if (curr && show_suggestions) {
        let word = "^" + curr.map(x => xw.grid[x]).join("").replaceAll("0", ".") + "$";

        // let filter = "^" + document.getElementById('filter').value + "$";

        let words = get_matches(word);

        document.getElementById('suggestions').innerHTML = words.join("<br>");

      } else {
        document.getElementById('suggestions').innerHTML = "";
      }

      if (selected_square_id > -1 && show_suggestions) {
        document.getElementById('poss').innerHTML = get_possible_letters(selected_square_id);
      } else {
        document.getElementById('poss').innerHTML = "";

      }


      // draw contents
      for (let i = 0; i < xw.N ** 2; i++) {
        let r = Math.floor(i / xw.N);
        let c = i % xw.N;

        let x = c * canvas.width / xw.N;
        let y = r * canvas.width / xw.N;


        if (nums[i] != 0) {
          let font_size = canvas.height / (3.5 * xw.N);
          ctx.textAlign = "left";
          ctx.textBaseline = "alphabetic";
          ctx.fillStyle = "black";
          ctx.font = font_size + "px Verdana";
          ctx.fillText(nums[i], x + font_size / 6, y + font_size);
        }

        if (xw.grid[i] == BLACK) {
          ctx.fillStyle = "black";
          ctx.fillRect(x, y, canvas.width / xw.N, canvas.height / xw.N);

        } else if (xw.grid[i] != WHITE && show_letters) {
          let font_size = (0.5) * canvas.height / xw.N;
          ctx.fillStyle = "black";
          ctx.textAlign = "center";
          ctx.textBaseline = "middle";
          ctx.font = font_size + "px Verdana";
          ctx.fillText(xw.grid[i].toUpperCase(), x + canvas.width / (2 * xw.N), y + canvas.width / (1.65 * xw.N));
        }

        if (curr && curr.includes(i)) {
          ctx.fillStyle = "rgb(0, 0, 255, 0.1)";
          ctx.fillRect(x, y, canvas.width / xw.N, canvas.height / xw.N);
        }

        if (selected_square_id == i) {
          ctx.lineWidth = "4";
          ctx.strokeStyle = "rgb(0, 0, 255)";
          ctx.beginPath();
          ctx.rect(x, y, canvas.width / xw.N, canvas.height / xw.N);
          ctx.stroke();
        }

        if (selected_square_id == xw.N**2  - 1 - i) {
          ctx.lineWidth = "4";
          ctx.strokeStyle = "rgb(0, 255, 0)";
          ctx.beginPath();
          ctx.rect(x, y, canvas.width / xw.N, canvas.height / xw.N);
          ctx.stroke();
        }

        // errors
        if (xw.grid[i] != BLACK && (xw.get_word(i, 1).length < 3 || xw.get_word(i, xw.N).length < 3)) {
          ctx.fillStyle = "rgb(255, 0, 0, 0.5)";
          ctx.fillRect(x, y, canvas.width / xw.N, canvas.height / xw.N);
        }

      }

    }


    function toggle_black(sid) {
      if ((xw.grid[sid] == BLACK || xw.grid[sid] == WHITE) && (xw.grid[xw.N ** 2 - sid - 1] == BLACK || xw.grid[xw.N ** 2 - sid - 1] == WHITE)) {
        xw.grid[sid] = WHITE + BLACK - xw.grid[sid];
        xw.grid[N ** 2 - sid - 1] = xw.grid[sid];
      }
    }


  
    function download_image() {
      selected_square_id = -1;
      update();
      let link = document.createElement('a');
      link.download = 'xw-puzzle.png';
      link.href = canvas.toDataURL();
      link.click();
    }
    


    // window.onbeforeunload = function () {
    //     return "Do you really want to close?";
    // };



    function handle_filler() {
      let k = Number(document.getElementById('k').value);
      let fill = xw.get_possible_fills(k);
      if (fill) {
        xw.grid = fill.grid;
      } else {
        alert('no possible fill');
      }
      
      update();
    }


  </script>
</html>






